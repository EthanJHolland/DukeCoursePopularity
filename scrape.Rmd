---
title: "Scraping"
author: "Ethan Holland"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message=F, include=F}
library(glue)
library(httr)
library(dplyr)
```

```{r notes}
# only includes undergraduate classes (although undergraduates can take graduate level classes)
# seminars and lectures
# ignores abroad classes
```


```{r}
#make a get request to a given url and parse response body as JSON
make.get <- function(url, sleep = 3){
  Sys.sleep(sleep)  # sleep between requests
  GET(url, accept_json()) %>% 
    content('parsed') %>% 
    return()
}

url.courses <- function(term, dept=''){
  return(glue(
    'https://beta.dukehub.duke.edu/psc/CSPRD01/EMPLOYEE/SA/s/WEBLIB_HCX_CM.H_BROWSE_CLASSES.FieldFormula.IScript_BrowseCourses?institution=DUKEU&term={term}&institution=DUKEU&acad_career=UGRD&subject={dept}'
  ))
}

url.sections <- function(term, courseid){
  return(glue(
    'https://beta.dukehub.duke.edu/psc/CSPRD01/EMPLOYEE/SA/s/WEBLIB_HCX_CM.H_BROWSE_CLASSES.FieldFormula.IScript_BrowseSections?institution=DUKEU&campus=&location=&course_id={courseid}&institution=DUKEU&acad_career=UGRD&term={term}'
  ))
}

url.description <- function(term, section.id){
  return(glue(
    'https://beta.dukehub.duke.edu/psc/CSPRD01/EMPLOYEE/SA/s/WEBLIB_HCX_CM.H_CLASS_SEARCH.FieldFormula.IScript_ClassDetails?institution=DUKEU&term=1700&class_nbr={section.id}'
  ))
}
```

```{r}
terms <- c(  # based on https://registrar.duke.edu/faculty-staff-resources/dukehub
  '2014 Fall' = 1500,
  '2015 Spring' = 1510,
  '2015 Fall' = 1540,
  '2016 Spring' = 1550,
  '2016 Fall' = 1580,
  '2017 Spring' = 1590,
  '2017 Fall' = 1620,
  '2018 Spring' = 1630,
  '2018 Fall' = 1660,
  '2019 Spring' = 1670,
  '2019 Fall' = 1700,
  '2020 Spring' = 1710
)

depts.pratt <- c('EGR', 'ME', 'BME', 'ECE', 'CEE', 'ENRGYEGR')
```

```{r}
#get courses from terms
courses <- lapply(terms, function(term){
  res <- make.get(url.courses(term))
  
  courses.notabroad <- res$courses[!sapply(res$courses, function(x) grepl('A', x$catalog_nbr, fixed=T))]  # remove abroad classes
  sapply(courses.notabroad, function(x) c('term' = term, 'courseid' = x$crse_id)) %>% t() %>% 
    as.data.frame(stringsAsFactors = F) %>% 
    group_by(courseid) %>% mutate(num.depts = n()) %>% unique() %>% ungroup() %>% 
    return()
}) %>% bind_rows()
```


```{r}
#get sections from courses
data.raw <- apply(courses %>% sample_n(10), 1, function(vec){  # TODO: apply to all courses
  print(vec)
  res <- make.get(url.sections(vec['term'], vec['courseid']))
  
  components <- get.prop(res$sections, 'component')
  lecture <- NULL
  for(section in res$sections){  # find lecture in primary department
    if(section$component %in% c('LEC', 'SEM')) lecture <- section
  }
  if(is.null(lecture)) return(data.frame())
  
  meeting.1 <- if(length(lecture$meetings) >= 1) lecture$meetings[[1]] else NULL
  
  data.frame(
    term = vec['term'],
    courseid = vec['courseid'],
    num.depts = vec['num.depts'],
    sectionid = lecture$class_nbr,
    has.disc = any(components == 'DIS'),
    has.lab = any(components == 'LAB'),
    enrolled = lecture$enrollment_total,
    capacity = lecture$class_capacity,
    component = lecture$component,
    dept = lecture$subject,
    number = lecture$catalog_nbr,
    title = lecture$descr,
    units = lecture$units,
    time.start = if(is.null(meeting.1) || is.null(meeting.1$meeting_time_start)) NA else meeting.1$meeting_time_start,
    time.end = if(is.null(meeting.1) || is.null(meeting.1$meeting_time_end)) NA else meeting.1$meeting_time_end,
    building = if(is.null(meeting.1) || is.null(meeting.1$bldg_cd)) NA else meeting.1$bldg_cd,
    meetings = if(is.null(meeting.1)) NA else sapply(lecture$meetings, function(meeting) meeting$stnd_mtg_pat) %>% paste(collapse=''),
  stringsAsFactors = F
  ) %>% return()
}) %>% bind_rows()


data <- data  %>% 
  mutate(
    is.focus = grepl('F', number, fixed=T),
    is.sem = grepl('S', number, fixed=T),
    is.pratt = dept %in% depts.pratt,
    number = gsub('[A-Z]+', '', number),
    level = case_when(
      nchar(number) == 2 ~ '<100',
      startsWith(number, '1') ~ '100',
      startsWith(number, '2') ~ '200',
      startsWith(number, '3') ~ '300',
      startsWith(number, '4') ~ '400',
      T ~ '>=500'
    ),
    campus = case_when(
      startsWith(building, '77') ~ 'west',
      startsWith(building, '70') ~ 'central',
      startsWith(building, '71') ~ 'central',
      startsWith(building, '72') ~ 'east',
      T ~ 'other'
    )
  )

# component - LAB (lab), LEC (lecture), IND (independent study), DIS (discussion), SEM (seminar), TUT (tutored? MUSIC 281T), MUS (music), REC (recitation)
# units - 0, 0.5, 1, etc
# suffixes - S (seminar), T (tutored?), A (abroad?), D (has discussion), L (has lab), F (foucus)
```

